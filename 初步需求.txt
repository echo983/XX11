---

# X11 GUI Bridge for LLM

## 需求规格 V0.2（视觉反馈迭代版）

---

## 1. 项目目标

构建一个 Windows 原生 Rust Daemon，通过 X11 协议驱动 GPT-5.2 生成图形化逻辑表达。
**V0.2 核心增强**：引入“视觉反馈环 (Visual Feedback Loop)”，通过草稿截图回传，实现 LLM 自我纠错与布局优化。

---

## 2. 运行环境

* OS：Windows
* X Server：VcXsrv (127.0.0.1:0.0)
* LLM 架构：
  - **Generator**: gpt-5.2 (负责初始设计与逻辑架构)
  - **Critic**: gpt-5-mini-2025-08-07 (负责视觉校审与坐标微调)

---

## 3. 总体架构

```
+-------------------+       +-----------------------+
|   GPT-5.2 (Gen)   | <---> | GPT-5-Mini (Critic)   |
+---------^---------+       +-----------^-----------+
          |                             |
      DSL(JSON) <---------------->  JPG Draft
          |                             |
+---------+-----------------------------+-----------+
|                Orchestrator                       |
|  (Session Manager & Iteration Controller)         |
+----+-------------------+---------------------+-----+
     |                   |                     |
 DSL |                   | Image Buffer        | X11 Events
     |                   |                     |
+----v----+      +-------v-------+      +------v------+
| DSL     |      | Off-screen    |      | X11 Backend |
| Parser  |      | Renderer      |      | (x11rb)     |
+---------+      +---------------+      +-------------+
```

---

## 4. 视觉反馈环逻辑 (The Loop)

为了解决坐标计算不准和布局重叠，系统执行以下循环（最多 4 次）：
1. **生成**：LLM 输出第一版 DSL JSON。
2. **离屏渲染**：Daemon 将 DSL 渲染为内存位图并编码为低分辨率 JPG。
3. **视觉校审**：将 JPG 与代码发给 Critic 模型。
4. **决策**：
   - 若发现问题 -> Critic 输出 `rejection_reason` 与修正后的完整 JSON -> 回到步骤 2。
   - 若完美 -> Critic 标记 `is_final: true` -> 最终渲染至用户 X11 窗口。

---

## 5. DSL 指令集 (AGD/0.1)

### 5.1 框架约束 (Structured Outputs)
所有输出必须符合定义的 JSON Schema，严禁自然语言污染。

### 5.2 绘图原语
- **clear**: `{"cmd": "clear", "color": "#RRGGBB"}`
- **rect**: `{"cmd": "rect", "id": "...", "x", "y", "w", "h", "fill", "stroke", "stroke_width", "clickable"}`
- **text**: `{"cmd": "text", "x", "y", "text", "color", "bg"}`
  - *注：若 text 在 rect 内，"bg" 必须设为 rect 颜色以实现视觉透明。*
- **line**: `{"cmd": "line", "x1", "y1", "x2", "y2", "color", "width"}`

---

## 6. 交互规范

- **延迟反馈**：本地 Daemon 不对 UI 进行语义解释。
- **DEBUG 存档**：开启 `AGD_DEBUG=1` 后，记录每一轮迭代的图、理由和 Token 消耗。
- **缓存敏感**：利用 Prompt Caching，通过固定指令前缀加速迭代。

---