# 项目状态与计划

## 当前状态
- 已完成 Rust 工程骨架、DSL 解析/校验、X11 窗口创建、基础绘制与点击闭环。
- 已接入 GPT-5.2 Responses API（JSON-only 输出），通过 OPENAI_API_KEY 驱动。
- 控制台输入文本可触发 LLM 生成新的 render，并回显到 X11 窗口。
- 文本渲染已改为本地 TTF 栅格化 + X11 PutImage（绕过 X11 core font 限制）。

## 现状偏离与差距（对照初步需求）
- 会话循环为最小实现：点击与控制台输入驱动 render，尚未实现完整状态机与节流策略。
- seq 策略仍较弱：允许相等但不允许递减；真实 LLM 时可能需要更严格的同步约束。
- 渲染仍是全量重绘，没有局部更新与重绘优化。
- 事件 DSL 只覆盖 click，未实现更多事件类型与回传策略。

## 近期计划（按可行性顺序）
1. 初始化 Rust 工程骨架与目录结构（`src/`、模块划分）。
2. 建立核心模块空壳与最小可编译入口（`main.rs`、`orchestrator`、`dsl`、`x11`、`state`、`llm`）。
3. 逐步填充 DSL 模型与校验规则（AGD/0.1 envelope + commands）。
4. 接入 x11rb，完成窗口创建与最小绘制闭环。
5. 接入事件循环与 click 事件到 DSL event。
6. 接入 LLM 调度（先以 mock 代替）。

## 现状偏离与差距（对照初步需求）
- 事件链路未完成：X11 click 还未转换为 AGD/0.1 event JSON，也未回传给 LLM 调度。
- 会话循环未建立：当前只有一次 render + 等待点击，没有持续的 render/event 循环。
- DSL 覆盖不完整：解析/校验已做，但 event DSL 与严格的 seq 同步策略尚未落地。
- 渲染能力有限：只实现 clear/rect/text/line 的最小绘制，未处理重绘节流与状态保持。
- 本地状态不足：hit-test 有基础实现，但未与事件 DSL 绑定，也未维护可点击区域表的生命周期。

## 下一步计划（最近三步）
1. 稳定文本渲染基线与字号（去除上下波动/裁切），确认中文与 emoji 完整显示。
2. 调整 LLM 回答策略与提示词，确保“图形化回答”稳定输出。
3. 事件节流与 UI 状态处理（hover/pressed 的本地绘制），避免高频回调。

## 当前问题与现象
- 中文/emoji：现已能显示，但字形出现上下波动、被裁切（只显示上半截）。
- seq 警告：模型可能返回相同 seq，已放宽为“相等不警告”，递减才警告。
- 渲染反馈：需要更明显的 UI 回答与可视化反馈。

## 已尝试与结果（按时间顺序）
- 尝试 X11 core font（image_text8/16）：中文/emoji 方块，需字体包支持。
- 试图加载 ISO10646-1 字体：仍乱码，依赖 VcXsrv 字体环境。
- 改为本地 TTF 栅格化（fontdue）→ PutImage：中文可见，但基线/行高抖动。
- 调整基线与行高算法：基于字体 ascent/descent 与行高，缓解但仍有裁切/波动。
- 允许空文本跳过渲染，避免 LLM 返回空 text 时报错。
- 将 system prompt 外置到 `prompts/system.txt` 并调整为“图形化回答”。

## 进度日志
- 2026-01-06：创建 `AGENTS.md`。
- 2026-01-06：创建 `STATUS.md`，明确当前状态与计划。
- 2026-01-06：初始化 Rust 工程骨架（`Cargo.toml` 与 `src/` 目录树）。
- 2026-01-06：添加核心模块空壳与最小入口（可编译占位）。
- 2026-01-06：实现 AGD/0.1 DSL 解析与基础校验（serde_json + 规则）。
- 2026-01-06：补充 DSL 深度校验（颜色格式、尺寸/宽度、文本非空等）。
- 2026-01-06：补充 DSL 规则（window 标题非空、id 非空约束）。
- 2026-01-06：接入 x11rb 最小窗口创建与 clear 绘制闭环。
- 2026-01-06：更新 LLM mock 输出为合法 AGD/0.1 render JSON。
- 2026-01-06：实现 rect/text/line 绘制与基础 hit-test 构建。
- 2026-01-06：补充现状偏离与下一步计划。
- 2026-01-06：接入 click event JSON 生成与一次点击驱动的 render 续航。
- 2026-01-06：加入 render/event 循环与 seq 单调校验（mock 递增）。
- 2026-01-06：设置默认鼠标光标，修复窗口内指针消失问题。
- 2026-01-06：点击 btn_ok 时 mock render 改变按钮颜色与文本，提供可见反馈。
- 2026-01-06：切换到 GPT-5.2 Responses API（JSON-only），由 OPENAI_API_KEY 驱动。
- 2026-01-06：提取 system prompt 到 `prompts/system.txt`，并支持控制台输入触发渲染。
- 2026-01-06：放宽空文本校验并调整提示为“图形化回答，不直接回显用户输入”。
- 2026-01-06：使用 X11 16-bit 文本绘制与 ISO10646-1 字体以支持中文。
- 2026-01-06：改为本地 TTF 栅格化文本并用 PutImage 绘制，规避 X11 字体限制。
- 2026-01-06：调整 text 基线与行高算法（ascent/descent），尝试修复裁切与抖动。
